{% extends "base.html" %}
{% load custom_filters_1 %}
{% block title %}<title>æ´¾æ£®Python-ä½¿ç”¨è€…ä¸­å¿ƒ</title>{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>ğŸ‘ï¸ æ´¾æ£®Python-ä½¿ç”¨è€…ä¸­å¿ƒ</h2>

  <ul class="nav nav-tabs" id="userTabs">
    <li class="nav-item"><a class="nav-link active" href="#profile" data-bs-toggle="tab">å€‹äººè³‡æ–™</a></li>
    <li class="nav-item"><a class="nav-link" href="#orders" data-bs-toggle="tab">ğŸ§¾ è¨‚å–®ç´€éŒ„</a></li>
    <li class="nav-item"><a class="nav-link" href="#wishlist" data-bs-toggle="tab">ğŸ§¡ æ”¶è—æ¸…å–®</a></li>
    <li class="nav-item"><a class="nav-link" href="#coupons" data-bs-toggle="tab">å„ªæƒ åˆ¸</a></li>
  </ul>

  <div class="tab-content mt-3">
    <div class="tab-pane fade show active" id="profile">
      <p>å§“åï¼š{{ user.username }}</p>
      <p>Emailï¼š{{ user.email }}</p>
      <p>é›»è©±ï¼š{{ user.phone }}</p>
      <p>åœ°å€ï¼š{{ user.address }}</p>
      <br>
      <div class="d-flex flex-column flex-sm-row gap-2 mt-3">
        <a href="{% url 'custom_change_password' %}" class="btn btn-outline-primary">ğŸ” ä¿®æ”¹å¯†ç¢¼</a>
        <a href="{% url 'password_reset' %}" class="btn btn-outline-secondary">ğŸ“© å¯„é€å¯†ç¢¼é‡è¨­ä¿¡</a>
      </div>
    </div>



    <div class="tab-pane fade" id="orders">
        {% if orders %}
            <div class="accordion" id="ordersAccordion">
                {% for order in orders %}
                    <div class="accordion-item mb-3">
                        <h2 class="accordion-header" id="heading{{ order.order_id }}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ order.order_id }}">
                                ğŸ§¾ è¨‚å–®ç·¨è™Ÿï¼š{{ order.order_id }}ï¼ˆ{{ order.order_date|date:"Y m d H:i" }}ï¼‰
                            </button>
                        </h2>
                        <div id="collapse{{ order.order_id }}" class="accordion-collapse collapse" data-bs-parent="#ordersAccordion">
                            <div class="accordion-body">
                                <p><strong>ğŸ’° ç¸½é‡‘é¡ï¼š</strong>NT${{ order.total_amount }}</p>
                                <p><strong>ğŸ“¦ è¨‚å–®ç‹€æ…‹ï¼š</strong>{{ order.order_status }}</p>
                                <p><strong>ğŸ’³ ä»˜æ¬¾ç‹€æ…‹ï¼š</strong>{{ order.payment_status }}ï¼ˆ{{ order.payment_method }}ï¼‰</p>
                                <p><strong>ğŸ“¬ é‹é€åœ°å€ï¼š</strong>{{ order.shipping_address }}ï¼ˆ{{ order.shipping_zip_code }}ï¼‰</p>

                                <table class="table table-sm table-bordered text-center">
                                    <thead class="table-light">
                                        <tr>
                                            <th>å•†å“åç¨±</th>
                                            <th>æ•¸é‡</th>
                                            <th>å–®åƒ¹</th>
                                            <th>å°è¨ˆ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in order.orderitem_set.all %}
                                            <tr>
                                                <td class="text-start">{{ item.product.product_name }}</td>
                                                <td>{{ item.quantity }}</td>
                                                <td>NT${{ item.price_at_purchase }}</td>
                                                <td>NT${{ item.price_at_purchase|multiply:item.quantity }}</td>
                                            </tr>
                                        {% empty %}
                                            <tr>
                                                <td colspan="4" class="text-muted">æ­¤è¨‚å–®å°šç„¡å•†å“æ˜ç´°ã€‚</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-center text-muted">ç›®å‰å°šç„¡è¨‚å–®ã€‚</p>
        {% endif %}
    </div>




    <div class="tab-pane fade" id="wishlist">
      {% if favorites %}
        <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4" id="wishlist-container">
          {% for item in favorites %}
            <div class="col wishlist-card" id="wishlist-item-{{ item.product.pk }}">
              <div class="card h-100 shadow-sm">
                <!-- æ­£ç¢ºï¼šåœ–ç‰‡æ˜¯ image_url -->
                <img src="{{ item.product.image_url }}" class="card-img-top" alt="{{ item.product.product_name }}">

                <div class="card-body d-flex flex-column">
                  <!-- æ­£ç¢ºï¼šå“åæ˜¯ product_name -->
                  <h5 class="card-title text-truncate" title="{{ item.product.product_name }}">
                    {{ item.product.product_name }}
                  </h5>

                  <!-- åƒ¹æ ¼ -->
                  <p class="card-text text-danger fw-bold">
                    NT${{ item.product.price }}
                  </p>

                  <!-- æŒ‰éˆ• -->
                  <div class="mt-auto d-flex justify-content-between">
                    <a href="{% url 'product_detail' item.product.pk %}" class="btn btn-sm btn-outline-primary">æŸ¥çœ‹å•†å“</a>

                    <button class="btn btn-sm btn-outline-danger remove-wishlist-btn"
                            data-url="{% url 'toggle_wishlist' item.product.pk %}"
                            data-product-id="{{ item.product.pk }}">
                      å–æ¶ˆæ”¶è—
                    </button>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">å°šç„¡æ”¶è—å•†å“ã€‚</p>
      {% endif %}
    </div>



    <div class="tab-pane fade" id="coupons">
      <p class="text-muted">å„ªæƒ åˆ¸åŠŸèƒ½å°šæœªé–‹æ”¾ã€‚</p>
    </div>
  </div>
</div>
{% endblock %}
<!-- ğŸ”» è‡ªå‹•åˆ‡æ› tab æ ¹æ“šç¶²å€ hashï¼ˆåªå½±éŸ¿æœ‰ hash çš„æƒ…æ³ï¼‰ -->
{% block script %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const buttons = document.querySelectorAll('.remove-wishlist-btn');
  buttons.forEach(btn => {
    btn.addEventListener('click', function () {
      const url = btn.dataset.url;
      const productId = btn.dataset.productId;

      fetch(url, {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Accept': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'removed') {
          const card = document.getElementById(`wishlist-item-${productId}`);
          if (card) card.remove();
        }
      })
      .catch(err => console.error('å–æ¶ˆæ”¶è—å¤±æ•—:', err));
    });
  });
});
</script>
{% endblock %}
